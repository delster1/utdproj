import os
import csv
import redis
import textwrap
from io import StringIO
import time
import subprocess
import signal

def main():
    RAW = """
    HeartRate	Temp	AccelX	AccelY	AccelZ
83	29.15027239	-18.04721387	-18.8890528	278.330545
67	30.3145116	-4.793232718	-0.651488762	252.2266901
78	23.75641662	11.50535235	-10.23744774	250.7470991
75	34.26409091	0.339783653	12.61985688	274.0330577
78	35	8.797938377	3.230243443	250.914445
70	27.28588502	-8.047540482	-2.608871747	274.5019589
72	23.6165087	14.31032732	-9.180152763	270.9271407
76	32.54464989	18.16218351	-7.728092627	255.7193385
80	25.51029725	3.509110214	7.949118884	266.0594262
75	32.93837424	-10.01066129	-1.48680239	254.1870923
79	29.76094266	0.240643549	-11.67736892	236.96197
78	25.78953331	3.215469136	4.249143915	253.7005398
79	29.79862207	14.2234927	-3.727263453	256.7208542
72	27.51820462	-1.404688351	-15.73211602	251.698712
81	28.71780496	-22.40535031	8.023184532	275.2326989
70	25.94283825	-4.555969299	5.025873212	256.3584857
72	26.65872345	0.701089319	8.98440525	257.820801
75	25.03066524	5.066096378	-12.316903	274.3542987
74	29.32576078	15.55733157	-7.110122517	244.0621232
77	27.9913455	2.412745209	-7.422054831	262.3846343
68	35	-11.14579019	-1.383716282	251.8403325
70	19.79302107	2.621400976	-0.622663207	247.7243045
70	34.55535016	-13.55724176	-0.003430576	253.0656409
76	28.82184354	12.54848187	-0.788907988	256.9686162
78	24.52295795	3.886199315	-11.49740893	255.0435692
78	24.02584679	-6.187313946	-4.433730391	272.7583624
65	26.92709978	11.95510179	-11.2066536	261.3913339
80	20.60399497	1.972291556	-10.1233141	251.5519226
76	33.22393431	-5.452337196	-1.653915602	246.9295877
79	27.97838717	-18.68226231	-3.91265236	264.7734156
66	26.71554584	-14.83148341	-8.716821375	246.0867555
81	28.66115714	11.50686299	-15.75692526	271.6639359
81	26.24757153	11.55232935	0.611376396	253.7704603
78	24.28976609	-2.388509585	-15.84510901	251.5554189
77	18	-15.00726561	-13.40733364	260.6492429
78	29.78580219	-0.126650548	-12.001456	266.3374107
80	26.08431242	-0.388065673	-0.771465363	243.240252
75	23.17961957	11.80963958	8.361971002	256.2575649
70	29.9371277	7.48335351	1.620127392	256.2564564
70	24.53901996	5.432796811	7.559215251	250.8833664
69	26.96794659	-8.279938113	2.820588267	261.4442067
65	21.21333416	-4.019735014	3.915986432	256.6372065
77	25.22736043	2.443052044	13.13615252	261.0957755
69	29.31995382	2.757925927	10.35815928	252.4916756
74	26.61026032	-8.553980787	-9.657330255	257.1589194
79	30.61713609	-10.0289752	8.31515911	262.611344
86	30.78296575	-0.949328101	14.69822032	246.02509
76	30.42662238	7.147273012	5.003356699	256.8681944
71	21.53906065	-0.045179609	10.04406613	264.9512924
76	34.77179305	-15.5181072	-9.045981456	277.0596398
82	26.62275033	-1.972097222	-0.091025006	254.5262273
65	21.80234604	12.83814207	-13.81877602	259.011114
74	26.48533522	-11.45797702	-6.317927179	256.2963571
80	26.2460879	2.80990537	3.761012333	260.0056213
69	24.23169614	12.89578186	10.4821729	267.8570157
70	35	-7.168839826	-0.915513681	272.2236668
79	21.65006178	5.997822898	-5.781430771	248.4403048
60	28.0624548	7.336625135	-5.54736729	265.0459977
75	31.82080883	8.303947506	6.620327931	258.0138295
70	20.36676754	-13.46984545	-1.215743263	276.0983796
78	28.9593401	11.01935865	-0.146241295	235.4418247
76	30.7303091	9.31061384	-34.62667796	254.5456952
71	29.52181262	0.610993919	-13.32540817	263.2931417
85	25.1127029	-6.796667963	-5.708966082	250.883391
76	27.59134424	-13.65756703	-13.12245734	257.6044595
82	26.55981215	-2.752526917	-7.647782107	270.1285456
67	24.45719101	-7.516422962	-2.711897415	250.3679035
79	26.4377378	-0.43008512	17.27886627	267.9042516
74	35	6.212792622	3.243655633	251.1323464
67	30.80454258	22.26091559	4.115657723	246.1895762
73	32.96651714	-4.268656216	7.477497344	243.4447719
76	24.85800421	-3.225033406	-5.809026053	255.3618599
74	26.83836858	21.7828	4.01766528	252.2660557
77	26.99234996	-1.016746351	-3.873833615	256.6699009
77	25.68630847	-5.953061573	-10.46869209	279.1492414
83	29.75374727	-17.28042837	12.72634422	247.0181517
75	28.76207601	0.428174671	-20.047398	254.835502
80	26.03335405	9.641129039	-11.60432195	252.6056134
78	27.12186506	-6.498985686	-2.064782603	252.989103
67	18	-11.79948466	-2.143174091	247.3047651
79	24.83511703	-2.530156678	-14.33841884	267.9327313
82	28.26882708	-0.832770603	8.340092627	258.3697699
72	32.06131017	-17.03295363	-17.68388415	249.6119247
71	20.71352567	-6.884288795	5.509760021	261.420411
71	30.62642866	2.553253542	-15.2867856	272.4961725
78	28.13934133	14.13872409	0.79406445	260.6769129
68	35	-10.77114924	-3.367260452	243.4213279
79	29.42588329	-4.209502985	-2.297318608	271.6176648
69	31.46996661	12.5911906	-3.077400668	258.2761224
83	20.61685754	7.491957066	1.55829353	260.1572994
71	23.04326681	-28.45588835	2.889116768	243.6133561
73	18	-9.535834752	-5.101876357	248.4904277
77	26.77911099	15.10177687	-0.916638439	251.4206192
84	26.97504265	24.53597631	-5.553778901	242.9153264
80	19.33925214	-2.946369433	-4.833574329	250.1818115
75	22.41346632	1.669003438	-6.437121631	250.9334659
70	29.23064227	6.098342533	10.78976316	267.0008441
69	32.41777917	2.330294583	-24.35962809	257.5730073
69	21.99884127	3.647562038	-2.552020165	253.0716744
79	27.15774354	9.926030168	2.610532506	260.3940688
72	26.47224884	-10.92868437	-2.229291394	254.0015848
72	28.59904578	-11.31871805	1.039481564	262.1420647
77	27.14989557	-10.5768733	1.685211784	243.4076976
65	26.68418859	10.54457667	14.15021613	251.3930281
75	26.00478991	-2.891025333	-11.50834355	265.1915391
79	20.58291664	-4.45019141	16.97280696	267.6675366
76	27.62782178	-16.04725193	-9.983683167	262.8363328
69	27.24203478	-2.265139725	26.01793282	256.0202283
69	27.85953156	-9.423697381	-3.832351222	251.3747674
79	28.97525926	-5.732273391	4.542153467	235.1563553
71	33.42131658	0.432383202	11.92398285	246.9975825
67	26.39235811	-7.516742304	-3.468251416	235.1808823
75	26.40671976	-9.618157693	7.743956088	251.4039488
72	26.37590916	8.743302022	-3.471121308	254.2581019
73	27.8911723	-0.171045204	7.320507663	250.6522391
76	20.8279205	2.053381647	0.03978752	235.3239824
72	26.09952603	1.033510699	-11.05299314	258.9771967
78	35	14.15802803	-7.09400786	248.7226102
71	23.15288598	-15.00169663	-0.685926632	255.0260256
71	29.86822267	-9.548143921	6.638940183	246.8343583
82	22.19662879	13.8424507	7.294229522	238.2086086
76	24.43962707	11.52815188	-15.26166379	243.1965536
73	34.93335623	1.776124172	-3.99255192	249.1861986
73	18	12.56222672	-5.459720166	267.6569275
81	26.51466532	-2.889241528	-10.40817658	258.8053872
70	23.1810114	-20.13705212	-1.192321108	242.964445
70	27.29982019	-13.31614735	3.66684663	236.3917681
76	30.32427128	-2.477580378	2.809695014	257.0613437
74	28.79966428	0.408250789	-21.49391197	263.1061952
70	19.60948596	7.009748216	0.485348428	247.2780798
71	23.08484097	16.14076349	9.882574419	243.4077617
72	26.26918221	-11.27334099	3.075689625	253.3421662
76	23.43723667	-5.405052158	-5.980890634	259.6390905
74	24.26842694	12.52587878	9.558538191	259.2021697
78	26.79509772	8.121794624	20.70631117	249.9731989
77	24.29143872	-0.775977843	6.009033528	252.3113507
71	19.97611248	-31.14169292	1.537109576	257.7058228
80	28.00423452	-0.480772469	8.517439178	250.3930412
80	27.85944767	-28.44023478	2.928481104	269.3231118
71	26.60558504	-6.796532207	13.16526516	247.4990261
73	21.44154102	11.54137521	4.44738963	274.9100433
69	29.17074482	-3.296359321	15.65445588	248.0938336
74	23.47797517	3.894773388	4.082684366	252.7994312
77	24.36871206	5.784236311	16.13342119	259.903269
68	18.35895984	-1.119971815	-0.713221337	243.9323788
71	24.22637123	-6.295591491	7.81569659	266.3275734
80	22.93682561	1.132082572	3.709594278	252.2335
81	21.22918291	-14.75759624	-12.74356088	232.3740304
71	29.2720981	3.635505415	-10.1232942	262.8832168
77	27.48420148	11.15252671	5.228256023	243.9886349
76	28.62070817	8.57634312	-3.349362228	235.6384948
71	18	1.047066737	5.604735846	256.3838247
78	28.38242215	8.210605495	-15.80475759	265.7580802
77	18	10.27484998	-7.497760417	260.5617929
77	27.44155609	-0.722470426	-8.176196925	262.5539993
    """

    cleaned = textwrap.dedent(RAW).strip()
    LOCAL_PORT = 63792
    HOSTNAME = "redis.d3llie.tech"
    LOCAL_HOST = "127.0.0.1"
    
    
    cloudflared_cmd = [
            "cloudflared", "access", "tcp",
            "--hostname", HOSTNAME,
            "--url", f"{LOCAL_HOST}:{LOCAL_PORT}",
            "--service-token-id", SERVICE_TOKEN_ID,
            "--service-token-secret", SERVICE_TOKEN_SECRET,
        ]

        # Output status information
    print(f"Starting Cloudflare proxy on {LOCAL_HOST}:{LOCAL_PORT} â†’ redis.d3llie.tech ...")

    # Make the actual subprocess to handle our connection
    proc = subprocess.Popen(
        cloudflared_cmd,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True,
    )
    # Wait briefly for the tunnel to come up
    time.sleep(0.5)

    if proc.poll() is not None:
        stderr = proc.stderr.read()
        raise RuntimeError(f"cloudflared exited early:\n{stderr}")

    # The main connection initialization block
    try:
        r = redis.Redis(
                host=f'{LOCAL_HOST}',
                port=LOCAL_PORT,
                username="default",
                password=os.getenv("REDIS_PASSWORD"),
                decode_responses=True,
            )
        
    except Exception as e:
        print(
            f"Failed to establish SQL connection!\nFailed with exception: {e}")
        if proc.poll() is None:
            proc.send_signal(signal.SIGINT)  # Tell it to close
            try:
                # Give it the chance to exit gracefully
                proc.wait(timeout=3)
            except subprocess.TimeoutExpired:
                proc.kill()  # Kill it if it takes too long

    reader = csv.DictReader(StringIO(cleaned), delimiter="\t", skipinitialspace=True)

    pipe = r.pipeline()
    for raw_row in reader:
        fields = {k.strip(): v.strip() for k, v in raw_row.items() if k and v}
        if fields:
            pipe.xadd("sensor_stream", fields)
    pipe.execute()

    print("Data successfully pushed as Redis lists!")

if __name__ == "__main__":
    main()
